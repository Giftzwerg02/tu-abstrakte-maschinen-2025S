name: Pandoc build

on: push

jobs:
  convert_via_pandoc:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
        with:
          path: main

      - name: Cache APT packages
        uses: actions/cache@v4
        with:
          path: /var/cache/apt/archives
          key: ${{ runner.os }}-apt-cache

      - name: Update APT
        run: sudo apt update

      - name: Create output directory
        run: mkdir -p out

      - name: Make files accessible to pandoc
        id: files_list
        run: |
          echo "files=$(printf '"%s" ' main/*.md)" >> $GITHUB_OUTPUT

      - name: Current date
        id: date
        run: echo "date=$(date +"%Y-%m-%d %H:%M")" >> $GITHUB_OUTPUT

      - name: Install Fonts
        run: |
          sudo apt install -y --no-install-recommends fonts-firacode fonts-roboto pandoc texlive-xetex

      - name: Convert Markdown to PDF
        run: |
          pandoc \
              -i main/*.md \
              -f gfm \
              --pdf-engine=xelatex \
              -V mainfont="Roboto" \
              -V monofont="Fira Code" \
              -V geometry:a4paper \
              -V geometry:margin=2cm \
              --toc \
              --metadata title="Abstrakte Maschinen Ausarbeitung - 2025S" \
              --metadata date="$(date +"%Y-%m-%d %H:%M")" \
              -s \
              -o out/script.pdf 

          # HTMl
          pandoc \
              -i main/*.md \
              -f gfm \
              --pdf-engine=xelatex \
              -V mainfont="Roboto" \
              -V monofont="Fira Code" \
              -V geometry:a4paper \
              -V geometry:margin=2cm \
              --toc \
              --metadata title="Abstrakte Maschinen Ausarbeitung - 2025S" \
              --metadata date="$(date +"%Y-%m-%d %H:%M")" \
              -s \
              -o out/script.html

      - name: Delete existing release (if it exists)
        uses: dev-drprasad/delete-tag-and-release@v1.1
        with:
          tag_name: latest
          delete_release: true
          delete_tag: true
          skip_if_not_found: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: latest
          name: "Latest Release"
          files: |
            out/script.pdf
            out/script.html
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
